<!-- templates/dynamic_table.htmla -->

{% extends './partials/system/layout1.html' %}

{% block content %}
{% include "./partials/system/alerts.html" %}
<!-- Breadcrumb -->
{% include 'partials/table/system/breadcrumbs.html' %}
{% import 'variables.html' as vars %}
<!-- Elemento oculto para pasar data al JS: nombre de tabla y columnas -->
<div class="flex flex-col h-[calc(100vh-188px)] sm:h-[calc(100vh-204px)]">
    <div class="grid grid-cols-1 overflow-auto">
        <div x-data="{ activeDefTab: '{{ activeDefTab }}' }" id="tabs">
            <ul class="flex flex-wrap text-xs text-center dark:border-gray/20 border-b border-lightgray/10">
                {% for tab in tabs %}
                    <li>
                        <a href="/dynamic/{{parent_table}}/related/{{id_parent_record}}/{{tab}}?parent_table={{parent_table}}&id_parent_record={{id_parent_record}}"
                            :class="activeDefTab === '{{ tab }}' ? 'bg-primary/10 text-primary' : 'bg-transparent text-gray hover:bg-primary/10 hover:text-primary'"
                            class="inline-flex items-center gap-2 px-5 py-3 rounded-t-lg">
                            {{ tab | title_format }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div> 
        <div class="h-4 bg-primary/10"></div>     
        <div class="flex flex-wrap items-center gap-5 p-5 border-2 border-gray/[0.14] rounded-lg" style="background: linear-gradient(90.17deg, rgba(48, 154, 252, 0.1) -3.08%, rgba(87, 84, 255, 0.1) 31.4%, rgba(255, 81, 164, 0.1) 65.89%, rgba(255, 124, 81, 0.1) 100.37%);">
            <img class="h-[60px] w-[60px] rounded-full" src="https://api.dicebear.com/9.x/initials/svg?seed={{ nombre }}&scale=80&backgroundColor=4697C7,4bb4d1&backgroundType=gradientLinear&backgroundRotation=0" alt="usuario Avatar">
            <div class="flex flex-col overflow-auto">
                {% for detail in primary_info %}
                    {% set value = detail %}
                    {% if detail in vars.date_time_columns %}
                        {% set value = detail | local_time %}
                    {% elif detail in vars.money_format_columns %}
                        {% set value = detail | money_format %}
                    {% endif %}

                    {% if loop.first %}
                        <h1 class="text-2xl font-bold">{{ value }}</h1>
                        <div class="flex flex-row gap-3 text-sm text-gray">
                    {% else %}
                            <span>{{ value }}</span>
                    {% endif %}
                    {% if loop.last %}
                        </div>
                    {% endif %}
                {% endfor %}

            </div>
                {% if table_name not in vars.no_edit_button and can_access('/dynamic/' ~ table_name ~ '/edit') %}
                    <a href="/dynamic/{{parent_table}}/form?id={{id_parent_record}}"
                        class="bg-gray/10 w-10 h-10 flex items-center justify-center hover:bg-dark hover:text-white dark:hover:bg-white dark:hover:text-dark border border-transparent rounded-md transition-all duration-300">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M9.57342 2.71915L10.1913 2.10123C11.2151 1.07742 12.8751 1.07742 13.8989 2.10123C14.9227 3.12503 14.9227 4.78494 13.8989 5.80874L13.2809 6.42666M9.57342 2.71915C9.57342 2.71915 9.65066 4.03223 10.8093 5.19082C11.9679 6.34942 13.2809 6.42666 13.2809 6.42666M9.57342 2.71915L3.89259 8.39997C3.50782 8.78475 3.31543 8.97714 3.14997 9.18926C2.9548 9.4395 2.78746 9.71025 2.65094 9.99672C2.5352 10.2396 2.44916 10.4977 2.27708 11.0139L1.54791 13.2014M13.2809 6.42666L7.60011 12.1075C7.21533 12.4923 7.02295 12.6847 6.81082 12.8501C6.56059 13.0453 6.28984 13.2126 6.00336 13.3491C5.7605 13.4649 5.50239 13.5509 4.98616 13.723L2.79865 14.4522M2.79865 14.4522L2.26393 14.6304C2.00989 14.7151 1.72981 14.649 1.54046 14.4596C1.35111 14.2703 1.28499 13.9902 1.36967 13.7361L1.54791 13.2014M2.79865 14.4522L1.54791 13.2014"
                                stroke="currentColor" stroke-width="1.6" />
                        </svg>
                    </a>
                {% endif %}
        </div>
        <div class="grid gap-5 grid-cols-1 sm:grid-cols-2 mt-2">
            <div class="relative bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg overflow-auto" style="max-height: calc(100vh - 390px);">
                <div class="flex flex-col gap-4">
                    {% for section, details in record_data.items() %}
                        <div class="bg-gray/[8%] dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-2 rounded-lg">
                            
                            <h2 class="text-lg font-semibold p-2">
                                {{ section | title_format }}
                            </h2>

                            <div class="flex flex-col gap-1 pl-2">
                                {% for detail, value in details.items() %}

                                    {% if detail in vars.date_time_columns %}
                                        {% set value = value | local_time %}
                                    {% elif detail in vars.money_format_columns %}
                                        {% set value = value | money_format %}
                                    {% endif %}

                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray">
                                            {{ detail | title_format }}
                                        </span>
                                        <span class="text-base">
                                            {{ value if value is not none else '' }}
                                        </span>
                                    </div>

                                {% endfor %}
                            </div>

                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="relative bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg overflow-auto" style="max-height: calc(100vh - 390px);">
                {% for section, indicadores in kpis.items() %}
                    <!-- Section Title -->
                    <h2 class="text-lg font-semibold pb-2">{{ section | title_format }}</h1>
                    <!-- KPIs -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                        {% for key, value in indicadores.items() %}
                            <div class="bg-gray/[8%] dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-2 rounded-lg flex flex-col text-center justify-center items-center">
                                <!-- KPI Title -->
                                <h2 class="text-sm font-semibold text-gray-600 p-2">{{ key | title_format }}</h2>

                                {% if key in vars.date_time_columns %}
                                    {% set value = value | local_time %}
                                {% elif key in vars.money_format_columns %}
                                    {% set value = value | money_format %}
                                {% endif %}

                                <!-- KPI Value -->
                                <span class="text-3xl font-bold text-primary">
                                    {{ value if value is not none else '' }}
                                </span>

                            </div>
                        {% endfor %}

                    </div>

                {% endfor %}

            </div>
        </div>
    </div>
</div>
{% include "./partials/system/loader.html" %}
{% endblock content %}