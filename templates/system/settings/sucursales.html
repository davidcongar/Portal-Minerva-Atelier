{% extends './partials/system/layout1.html' %}

{% block content %}
{% include "./partials/system/alerts.html" %}
{% include 'partials/table/breadcrumbs.html' %}
<div class="flex flex-col gap-5 min-h-[calc(100vh-188px)] sm:min-h-[calc(100vh-204px)]">
    <div class="grid grid-cols-1 gap-4 flex-1">
        <div class="flex gap-5 items-stretch relative overflow-hidden" x-data="{activeTab:'users'}">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 rounded-lg p-5 absolute w-[240px] z-20 flex-none -left-[410px] xl:static overflow-hidden overflow-y-auto h-[calc(100vh-188px)] sm:h-[calc(100vh-204px)]" >
                <div class="flex flex-col space-y-5">
                    <a href="/settings/usuarios" 
                    class="flex duration-300 p-5 text-sm font-semibold items-center gap-3 rounded-lg bg-gray/[8%] text-gray hover:bg-primary hover:text-white">
                        Usuarios
                    </a>                    
                    <a href="/settings/sucursales" 
                    class="flex duration-300 p-5 text-sm font-semibold items-center gap-3 rounded-lg bg-primary text-white">
                        Sucursales
                    </a>
                </div>                
            </div>
            <div class="flex flex-col flex-1 w-full h-full overflow-hidden">
                <div id="table-data" data-table="/dynamic/sucursales/data" data-columns='{{ columns|tojson }}' hidden></div>
                    <div class="flex flex-col h-[calc(100vh-188px)] sm:h-[calc(100vh-204px)]"  x-init="init()">
                                    <div class="grid grid-cols-1 gap-5">
                                        <div class="sticky top-0 bg-lesswhite dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                                            <div class="overflow-auto space-y-4" x-data="tabla" x-init="initData(); $watch('searchInput', value => { search(value) })">
                                                <div class="flex justify-between items-center gap-3">
                                    <h2 class="text-base font-semibold mb-4">{{ table_name|title_format }}</h2>
                                </div>
                                <!-- Sección de vista y búsqueda -->
                                <div class="flex justify-between items-center gap-3">
                                    <div class="flex space-x-2 items-center">
                                        <p class="text-sm">Ver</p>
                                        <select id="filter" class="form-select !w-20" x-model="view" @change="changeView()">
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="25">25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <input id="search" x-model="searchInput" type="text" class="form-input" placeholder="Buscar...">
                                    </div>
                                </div>

                                <div id="table_view" class="flex-1 overflow-y-auto" style="max-height: calc(100vh - 470px)">
                                        <table class="w-full table-hover table-striped">
                                            <thead class="text-left bg-lesswhite dark:bg-dark sticky top-0 z-5">
                                                <tr>
                                                    {% for column in columns %}
                                                    <th data-column="{{ column }}">
                                                        <div class="flex items-center justify-between gap-2">
                                                            <p>{{ column|title_format }}</p>
                                                            <div class="flex flex-col">
                                                                <!-- Icono para ordenar ascendente -->
                                                                <svg @click="sort('{{ column }}', sorted.rule === 'asc' ? 'desc' : 'asc')"
                                                                    fill="none" stroke-linecap="round" stroke-linejoin="round"
                                                                    stroke-width="4" viewBox="0 0 24 24" stroke="currentColor"
                                                                    class="h-3 w-3 cursor-pointer text-muted"
                                                                    x-bind:class="{'!text-black': sorted.field === '{{ column }}' && sorted.rule === 'asc'}">
                                                                    <path d="M5 15l7-7 7 7"></path>
                                                                </svg>
                                                                <!-- Icono para ordenar descendente -->
                                                                <svg @click="sort('{{ column }}', sorted.rule === 'desc' ? 'asc' : 'desc')"
                                                                    fill="none" stroke-linecap="round" stroke-linejoin="round"
                                                                    stroke-width="4" viewBox="0 0 24 24" stroke="currentColor"
                                                                    class="h-3 w-3 cursor-pointer text-muted"
                                                                    x-bind:class="{'!text-black': sorted.field === '{{ column }}' && sorted.rule === 'desc'}">
                                                                    <path d="M19 9l-7 7-7-7"></path>
                                                                </svg>
                                                            </div>
                                                        </div>
                                                    </th>
                                                    {% endfor %}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Se recorre la lista de registros obtenidos dinámicamente -->
                                                <template x-for="(record, index) in items" :key="index">
                                                    <tr class="cursor-pointer hover:bg-gray-100" >
                                                        <!-- Se recorre el array de columnas que se pasó desde el servidor -->
                                                        <template x-for="(col, i) in columns" :key="i">
                                                        <td style="word-wrap: break-word;word-break: break-word;white-space: normal;overflow: hidden;text-overflow: ellipsis">
                                                            <!-- Caso especial para pedidos_online -->
                                                            <template x-if="col.toLowerCase() === 'pedidos_online'">
                                                                <div class="flex  items-center">
                                                                    <div class="togglebutton inline-block">
                                                                        <label :for="`toggle-${index}`" class="flex items-center cursor-pointer">
                                                                            <div class="relative">
                                                                                <!-- bind with x-model to a temp property -->
                                                                                <input type="checkbox" class="sr-only" :id="`toggle-${index}`" @change="update_record('{{ table_name }}', record, col, record[col])" :checked="record[col] === true">
                                                                                    <div class="block band bg-gray/20 w-7 h-4 rounded-full"></div>
                                                                                    <div class="dot absolute left-1 top-1/2 -translate-y-1/2 right-0 bg-white w-2.5 h-2.5 rounded-full transition"></div>
                                                                                </div>
                                                                            </div>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                            <!-- Render default para las demás columnas -->
                                                            <template x-if="col.toLowerCase() !== 'pedidos_online'">
                                                                <span 
                                                                    x-text="record[col] 
                                                                        ? (col.includes('importe') || col.includes('$') || col.includes('valor') || col.includes('comisiones') || col.includes('monto') || col.includes('descuentos') || col.includes('precio')|| col.includes('subtotal')|| col.includes('propina') || col.includes('balance') || col.includes('costo') || col.includes('sueldo') || col.includes('utilidad')|| col.includes('ticket_promedio')|| col.includes('ingresos')|| col.includes('gastos')|| col.includes('nomina')
                                                                            ? money_format(record[col]) 
                                                                            : (col.includes('porcentaje') || col.includes('%') 
                                                                                ? record[col] + '%' 
                                                                                : (col.includes('cantidad') 
                                                                                    ? Number(record[col]).toLocaleString() 
                                                                                    : record[col]))) 
                                                                        : '-'">
                                                                </span>
                                                            </template>
                                                        </td>
                                                        </template>
                                                    </tr>
                                                </template>
                                                <!-- Si no hay registros, se muestra un mensaje -->
                                                <tr x-show="isEmpty()">
                                                    <td :colspan="columns.length" class="text-center text-gray-500">
                                                        No se encontraron registros
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                </div>
                                {% include 'partials/table/pagination.html' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/system/data-search.js"></script>
<script src="/static/js/system/data_table.js"></script>
<script src="/static/js/system/loader.js"></script>
<script src="/static/js/system/dynamic_table_init.js"></script>
<script src="/static/js/system/format_functions.js"></script>
<script>
    function update_record(table_name,record,column,value) {
        if(value===true){
            value=false;
        }else{
            value=true;
        }
        fetch(`/dynamic/${table_name}/double_table/update/${column}/${record.id}/${value}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.message !== "" && data.status==='warning') {
                window.dispatchEvent(new CustomEvent('show-warning', {
                    detail: data.message   // the message from your AJAX or backend
                }));
                warningAlert.style.display = 'flex';  // Show the warning message
                warningAlert.style.opacity = '1';  // Set opacity to 1 for showing
                setTimeout(function() {
                    warningAlert.style.opacity = '0';  // Start fading out
                    // After the fade-out animation is complete, hide the element
                    setTimeout(function() {
                        warningAlert.style.display = 'none';
                    }, 1000);  // Match this delay with the CSS transition time (1s)
                }, 3000);
            }else{
                window.location.reload();
            }
        })
        .catch(error => console.error("Error:", error));
    }
</script>
{% endblock content %}