{% extends './partials/system/layout1.html' %}
<!-- templates/dynamic_form.html -->
{% block content %}
{% include './partials/system/alerts.html' %}
<!-- Breadcrumb -->
{% include 'partials/table/breadcrumbs.html' %}
{% set columns_foreign_options=['regimen_fiscal','unidad_de_medida','inventariable','prioridad','estatus', 'genero','estado_civil','tipo_de_cuenta','tipo_de_ajuste','forma_de_pago','uso_de_cfdi','metodo_de_pago']%}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
/* Default (light mode) styles */
    .select2-container--default .select2-selection--multiple {
        background-color: rgba(119, 128, 161, 0.08);
        border-radius: 0.25rem;
        border-width: 2px;
        border-color: rgb(119 128 161 / 0.1);
        font-size: 0.875rem;
        color: #1f2937;
    }

    /* Selected items in Dark Mode */
    .dark .select2-container--default .select2-selection__choice {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
        color: #e5e7eb;
    }
    /* Style for single select dropdown */
    .select2-container--default .select2-selection--single {
        background-color: rgba(119, 128, 161, 0.08);
        border-radius: 0.25rem; /* rounded corners */
        border-width: 2px;
        border-color: rgb(119 128 161 / 0.1);
        font-size: 0.875rem; /* Tailwind text-sm */
        height: 2.5rem; /* optional: align with Tailwind h-10 */
        display: flex;
        align-items: center;
    }

    /* Dark mode selected item */
    .dark .select2-container--default .select2-selection--single {
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
    }
    .dark .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #e5e7eb;
    }

</style>
<div class="flex flex-col gap-5  h-[calc(100vh-188px)] sm:h-[calc(100vh-204px)]" >
    <div class="grid grid-cols-1 gap-5">
                    <!-- Título del form -->
            <h2 class="text-base font-semibold">
                {{ action }} en {{ table_name|title_format }}
            </h2>
        <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 px-5 rounded-lg overflow-y-auto" style="max-height: calc(100vh - 240px);">
            <!-- form -->
            <form method="POST" class="space-y-4" id="dynamic_form"  
                action="{{ url_for('dynamic.edit', table_name=table_name, id=record.id) if record else url_for('dynamic.add', table_name=table_name, id_parent_record=id_parent_record, parent_table=parent_table) }}" 
                enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% for column in columns %}
                    {% if column != "id" %}
                    <div class="space-y-2">
                        <label for="{{ column|title_format }}" class="text-sm text-lightgray capitalize">
                            {{ column|title_format }}
                            {% if column in required_fields %}
                                <span class="text-red-500">*</span>
                            {% endif %}
                        </label>
                        <br>
                        {% if foreign_options is defined and column in foreign_options %}
                        <!-- Multi - Select --> 
                            {% if column in many_to_many_data%}
                                {% for field, data in many_to_many_data.items() %}
                                    <select id="{{ field }}" name="{{ field }}" class="js-example-basic-multiple"  multiple {% if column in required_fields %} required {% endif %}>
                                        {% for option in data.options %}
                                            <option value="{{ option.id }}" {% if option.id in data.selected %} selected {% endif %}>
                                                {{ option.nombre or option.nombre_completo or option.id_cliente.nombre_completo or option.id_visualizacion }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% endfor %}
                            {% elif column in multiple_choice_data%}
                                {% for field, data in multiple_choice_data.items() %}
                                    <select id="{{ field }}" name="{{ field }}" class="js-example-basic-multiple"  multiple {% if column in required_fields %} required {% endif %}>
                                        {% for option in data.options %}
                                            <option value="{{ option }}" {% if option.id in data.selected %} selected {% endif %}>
                                                {{ option }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% endfor %}
                            {%else%}
                                <select id="{{ column }}" name="{{ column }}" class="searchable-select" {% if column in required_fields %} required {% endif %}
                                    {% if not record and default_variable_values.get(column) and default_variable_values.get(column)!='None'  %} disabled {% endif %}>
                                    <option value="">
                                        Selecciona una opción
                                    </option>
                                    {% for option in foreign_options[column] %}
                                         <!-- Opciones de select dentro de foreign options que no sean de otras bases-->
                                        {% if column in columns_foreign_options %}
                                            <option value="{{ option }}" {% if record and record[column] == option %}selected{% endif %} {% if default_variable_values[column] == option %}selected{% endif %}>
                                                {{ option }}
                                            </option>
                                         <!-- Opciones de select dentro de foreign options que sean de otras bases-->
                                        {% else %}
                                            <option value="{{ option.id }}" 
                                                {% if (record and record[column] == option.id) 
                                                or (default_variable_values and (default_variable_values.get(column) | string) == (option.id | string)) %}
                                                selected
                                                {% endif %}
                                                {% if form_filters[column] %}
                                                    data-filter="{{ option[form_filters[column]] }}"
                                                {% endif %}
                                                >
                                                {% if column=='id_proyecto' %}
                                                    {{ option.id_visualizacion| string+' - '+option.categoria.nombre| string }}
                                                {% elif column=='id_compra' %}
                                                    {{ option.id_visualizacion| string+' - '+option.proveedor.nombre| string+' - '+option.fecha_orden| string }}                                                    
                                                {% else %}
                                                    {{option.nombre or option.nombre_completo or option.nombre_empresa or option.id_visualizacion }}
                                                {% endif %}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            {%endif%}
                        <!-- Select -->
                        {% else %}
                            {% if "dd" in column %}
                                <!-- Renderizar el campo como un select multiple -->
                                <select name="{{ column }}"  id="{{ column  }}" class="js-example-basic-multiple" multiple="multiple" {% if column in required_fields %} required {% endif %}>
                                </select>
                            {% else %}
                                {% if "fecha_hora" in column %}
                                    <input type="datetime-local" id="{{ column }}" name="{{ column }}" value="{{ (record[column] | local_time) if record else default_variable_values[column] }}" class="form-input rounded-lg" style="width:40%" {% if column in required_fields %} required {% endif %}>
                                {% elif "fecha" in column %}
                                    <!-- Campo de fecha -->
                                    <input type="date" id="{{ column }}" name="{{ column }}" value="{{record[column] if record else default_variable_values[column] }}" class="form-input rounded-lg" style="width:40%" {% if column in required_fields %} required {% endif %}>
                                {% elif "tiempo" in column %}
                                    <input type="time" id="{{ column }}" name="{{ column }}" value="{{record[column] if record else default_variable_values[column] }}" class="form-input rounded-lg" style="width:40%"  {% if column in required_fields %} required {% endif %}>
                                {% else %}
                                <!-- Campo de texto normal -->
                                    <input type="text" id="{{ column }}" name="{{ column }}" value="{{record[column] if record else default_variable_values[column]}}"class="form-input rounded-lg"  {% if column in required_fields %} required {% endif %}>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
                {% if table_name == "archivos" %}
                    <div class="flex items-center gap-2 mt-4">
                        <input type="file" id="file-upload" name="archivo" class="hidden">
                        <label for="file-upload"
                            class="btn flex items-center gap-2 bg-primary border border-primary rounded-md text-white transition-all duration-300 hover:bg-primary/[0.85] hover:border-primary/[0.85] cursor-pointer">
                            Seleccionar archivo
                        </label>
                        <span id="file-name" class="file-name text-gray-500 ml-2">
                            No se ha seleccionado ningún archivo
                        </span>
                        <button type="button" id="delete-file-btn"
                            class="flex items-center justify-center text-red-500 hover:text-red-700 p-2 rounded-full hover:opacity-80 rotate-0 hover:rotate-180 transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5">
                                <path
                                    d="M12.0007 10.5865L16.9504 5.63672L18.3646 7.05093L13.4149 12.0007L18.3646 16.9504L16.9504 18.3646L12.0007 13.4149L7.05093 18.3646L5.63672 16.9504L10.5865 12.0007L5.63672 7.05093L7.05093 5.63672L12.0007 10.5865Z"
                                    fill="currentColor"></path>
                            </svg>
                        </button>
                    </div>
                {% endif %}

                <!-- Botones de acción -->
                <div class="flex items-center gap-4 p-5 pt-0">
                    <button type="submit"
                        class="btn border text-primary border-transparent rounded-md transition-all duration-300 hover:text-white hover:bg-primary bg-primary/10">
                        Guardar
                    </button>
                    <a href="{{ url_for('dynamic.table_view', table_name=table_name) }}"
                    class="btn border text-danger border-transparent rounded-md transition-all duration-300 hover:text-white hover:bg-danger bg-danger/10">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
  const filters = {{ form_filters | tojson }};
  Object.entries(filters).forEach(([childColumn, parentColumn]) => {
    const $parent = $(`#${parentColumn}`);
    const $child = $(`#${childColumn}`);

    if ($parent.length === 0 || $child.length === 0) return;

    // Save all original options (excluding the default one)
    const allOptions = $child.find("option").not('[value=""]').clone();

    function filterChildOptions() {
      const selectedValue = $parent.val();

      // Clear everything
      $child.empty();

      // Always add default option
      $child.append('<option value="">Selecciona una opción</option>');

      // Append only matching options
      allOptions
        .filter((_, opt) => $(opt).data("filter") == selectedValue)
        .each((_, opt) => $child.append($(opt).clone()));

      // Refresh Select2
      $child.trigger("change");
    }

    // Init Select2 (if not already)
    if (!$child.data("select2")) {
      $child.select2({
        placeholder: "Selecciona una opción",
        allowClear: true
      });
    }

    // Attach listener
    $parent.on("change", filterChildOptions);

    // Run once at page load
    filterChildOptions();
  });
</script>
<script>
    $(document).ready(function () {
        $("form").on("submit", function () {
            $(this)
                .find(":input:disabled")
                .prop("disabled", false);
        });
    });
    $(document).ready(function () {
        $('.js-example-basic-multiple').select2({
            width: '100%',
            dropdownAutoWidth: true,
        });
    });
    $(document).ready(function() {
        $('.searchable-select').select2({
        width: '100%'
        });
    });
    // Upfecha the span with the selected file name
    document.getElementById("file-upload").addEventListener("change", function () {
        const fileNameSpan = document.getElementById("file-name");
        const fileName = this.files[0]?.name || "No se ha seleccionado ningún archivo";
        fileNameSpan.textContent = fileName;
    });

    // Clear the file input when the delete button is clicked
    document.getElementById("delete-file-btn").addEventListener("click", function () {
        const fileInput = document.getElementById("file-upload");
        fileInput.value = ""; // Clear the file input
        document.getElementById("file-name").textContent = "No se ha seleccionado ningún archivo";
    });
    document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);

        params.forEach((value, key) => {
            let field = document.querySelector(`[name="${key}"]`);
            if (!field) return;

            if (field.tagName === "SELECT") {
                if (field.multiple) {
                    let values = value.split(",");
                    for (let opt of field.options) {
                        if (values.includes(opt.textContent.trim())) {
                            opt.selected = true;
                        }
                    }
                } else {
                    for (let opt of field.options) {
                        if (opt.textContent.trim() === value) {
                            opt.selected = true;
                            break;
                        }
                    }
                }
                $(field).trigger('change'); // Refresh Select2 UI if applied

            } else if (field.type === "checkbox" || field.type === "radio") {
                field.checked = (field.value === value);
            } else {
                field.value = value;
            }
        });
    });
</script>
<script>
        (
    function fillInputsFromUrl() {
      const params = new URLSearchParams(window.location.search);

      params.forEach((value, key) => {
        const input = document.querySelector(`[name="${key}"]`);
        if (input) {
          input.value = value;
        }
      });
    })();
</script>
{% if parent_record %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const parent_record = {{ parent_record | tojson }};
            const params = new URLSearchParams(window.location.search);
            const id_parent_record = params.get('id_parent_record');

            if (!id_parent_record) return;

            // Helper: safely set value only if the option exists
            const setSelectValueIfExists = ($el, value) => {
                if ($el.find(`option[value="${value}"]`).length > 0) {
                    $el.val(value).trigger('change').prop('disabled', true);
                    return true;
                }
                return false;
            };

            // Handle list or single select ID
            if (Array.isArray(parent_record)) {
                for (const id of parent_record) {
                    const $el = $('#' + id);
                    if ($el.length && setSelectValueIfExists($el, id_parent_record)) {
                        break; // stop after successful assignment
                    }
                }
            } else {
                const $el = $('#' + parent_record);
                if ($el.length) {
                    setSelectValueIfExists($el, id_parent_record);
                }
            }
        });
    </script>
{% endif %}

{% if javascript and record %}
    <script src="{{ url_for('static', filename='js/form_logic/edit/' ~ table_name ~ '.js') }}"></script>
{% elif javascript %}
    <script src="{{ url_for('static', filename='js/form_logic/add/' ~ table_name ~ '.js') }}"></script>
{% endif %}

{% endblock content %}